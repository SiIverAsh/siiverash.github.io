<script>
    // 1. æ—¶é’Ÿé€»è¾‘
    function updateClock() {
        const now = new Date();
        const timeEl = document.getElementById('clock-time');
        const dateEl = document.getElementById('clock-date');
        const lunarEl = document.getElementById('clock-lunar');

        if(timeEl) timeEl.textContent = now.toLocaleTimeString('zh-CN', { hour12: false });
        if(dateEl) dateEl.textContent = now.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        
        try {
            if(lunarEl) {
                const lunar = new Intl.DateTimeFormat('zh-u-ca-chinese', {day:'numeric', month:'long'}).format(now);
                lunarEl.textContent = "å†œå† " + lunar;
            }
        } catch(e) {}
    }
    setInterval(updateClock, 1000); updateClock();

    // 2. å†å²è®°å½•åŠ è½½
    function loadHistory() {
        const container = document.getElementById('history-content');
        if (container && window.siteData && window.siteData.history) {
            container.innerHTML = window.siteData.history.map(item => 
                `<div class="history-item"><span class="history-year" style="color: var(--primary-color); font-weight: bold;">${item.year}</span><br>${item.event}</div>`
            ).join('');
        }
    }
    window.addEventListener('DOMContentLoaded', loadHistory);

    // 4. åŠ¨æ¼«é¡µé¢ä¸“å±é€»è¾‘
    function loadAnimeExtras() {
        const cvName = document.getElementById('cv-name');
        if (cvName && window.siteData && window.siteData.cv_recommend) {
            const cv = window.siteData.cv_recommend;
            cvName.textContent = cv.name;
            document.getElementById('cv-agency').textContent = "ğŸ¢ " + cv.agency;
            document.getElementById('cv-hometown').textContent = "ğŸ“ " + cv.hometown;
            document.getElementById('cv-works').textContent = "ä»£è¡¨ä½œ: " + cv.works;
            document.getElementById('cv-intro').textContent = cv.intro;
            const wikiLink = document.getElementById('cv-wiki-link');
            if (wikiLink) {
                wikiLink.href = "https://zh.moegirl.org.cn/" + encodeURIComponent(cv.name);
            }
        }

        // è¯†åˆ«åŠ¨æ¼«åšæ–‡è¯¦æƒ…é¡µçš„æ ‡ç­¾
        const wikiTitle = document.getElementById('wiki-title');
        const tagSource = document.getElementById('data-post-tags');
        if (wikiTitle && tagSource) {
            // è·å–æ–‡ç« çœŸå®çš„æ ‡ç­¾åˆ—è¡¨
            const postTags = tagSource.textContent.split(',').map(t => t.trim());
            // æ’é™¤æ‰éåŠ¨æ¼«åçš„é€šç”¨æ ‡ç­¾ (å¤§å¹…æ‰©å……è¿‡æ»¤è¯åº“)
            const ignoreTags = ['åŠ¨æ¼«', 'æ‹çˆ±ç•ª', 'æˆé•¿', 'äºŒæ¬¡å…ƒ', 'æ„Ÿæƒ³', 'å¹æ°´', 'æ–°ç•ª', 'è®°å½•', 'åæ§½', 'ç»å…¸', 'ç¥ä½œ', 'è¡¥ç•ª'];
            // æ‰¾åˆ°ç¬¬ä¸€ä¸ªä¸åœ¨è¿‡æ»¤åˆ—è¡¨ä¸­çš„æ ‡ç­¾ï¼Œå³è§†ä¸ºåŠ¨æ¼«å
            const animeTitle = postTags.find(tag => !ignoreTags.includes(tag));
            
            if (animeTitle) {
                wikiTitle.textContent = animeTitle;
                document.getElementById('wiki-desc').textContent = "ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¯ç›´æ¥åœ¨ Bangumi (ç•ªç»„è®¡åˆ’) ä¸­æŸ¥çœ‹å…³äºã€Š" + animeTitle + "ã€‹çš„è¯¦ç»†èµ„æ–™ã€è¯„åˆ†åŠè®¨è®ºã€‚";
                document.getElementById('wiki-bgm-link').href = "https://bgm.tv/subject_search/" + encodeURIComponent(animeTitle) + "?cat=2";
            } else {
                // å¦‚æœæ²¡æ‰¾åˆ°åˆé€‚æ ‡ç­¾ï¼Œå¡ç‰‡ä¿æŒéšè—æˆ–ä½¿ç”¨æ ‡é¢˜é™çº§
                const infoCard = document.querySelector('.anime-info-card');
                if (infoCard) infoCard.style.display = 'none';
            }
        }
    }
    window.addEventListener('DOMContentLoaded', loadAnimeExtras);

    // 5. é‚®ç®±æ˜¾ç¤ºé€»è¾‘
    function showEmail(event, email) {
        // é˜²æ­¢ç‚¹å‡»ç©¿é€
        event.stopPropagation();
        
        // ç§»é™¤å·²å­˜åœ¨çš„æç¤ºæ¡†
        const oldTip = document.getElementById('email-tooltip');
        if (oldTip) oldTip.remove();

        const tip = document.createElement('div');
        tip.id = 'email-tooltip';
        tip.className = 'glass-card email-pop';
        tip.textContent = email;
        tip.style.left = (event.pageX + 10) + 'px';
        tip.style.top = (event.pageY + 10) + 'px';
        
        document.body.appendChild(tip);

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­
        const closeTip = () => {
            tip.classList.add('fade-out');
            setTimeout(() => tip.remove(), 300);
            document.removeEventListener('click', closeTip);
        };
        setTimeout(() => document.addEventListener('click', closeTip), 10);
    }

    const sinput = document.getElementById('search-input');
    const sresults = document.getElementById('results-container');
    if(sinput) {
        sinput.addEventListener('input', () => { sresults.style.display = sinput.value ? 'block' : 'none'; });
        SimpleJekyllSearch({
            searchInput: sinput, 
            resultsContainer: sresults,
            json: '{{ site.baseurl }}/search.json',
            searchResultTemplate: '<li><a href="{url}">{title}</a></li>',
            noResultsText: '<li><p style="padding:0 15px; color:#999;">æ— å†…å®¹</p></li>',
            limit: 8
        });
    }

    // 6. æ·±è‰²æ¨¡å¼åˆ‡æ¢é€»è¾‘
    const themeToggle = document.getElementById('theme-toggle');
    const body = document.body;
    const icon = themeToggle.querySelector('i');

    function syncCodeBlocks() {
        const isDark = body.classList.contains('dark-mode');
        const bg = isDark ? '#1e1e1e' : '#f6f8fa';
        const color = isDark ? '#f5f5f5' : '#333';
        document.querySelectorAll('pre, .highlight, code').forEach(el => {
            el.style.setProperty('background-color', bg, 'important');
            el.style.setProperty('color', color, 'important');
        });
    }

    // åˆå§‹åŒ–ï¼šæ£€æŸ¥å­˜å‚¨æˆ–ç³»ç»Ÿåå¥½
    const savedTheme = localStorage.getItem('theme');
    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

    if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
        body.classList.add('dark-mode');
        icon.classList.replace('fa-sun', 'fa-moon');
    }
    
    setTimeout(syncCodeBlocks, 100);

    themeToggle.addEventListener('click', () => {
        body.classList.toggle('dark-mode');
        const isDark = body.classList.contains('dark-mode');
        
        // æ›´æ–°å›¾æ ‡
        if (isDark) {
            icon.classList.replace('fa-sun', 'fa-moon');
            localStorage.setItem('theme', 'dark');
        } else {
            icon.classList.replace('fa-moon', 'fa-sun');
            localStorage.setItem('theme', 'light');
        }
        syncCodeBlocks(); // åˆ‡æ¢æ—¶åŒæ­¥
    });
</script>
