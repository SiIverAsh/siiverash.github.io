<script>
    /**
     * æ›´æ–°æ—¶é’ŸåŠŸèƒ½ï¼ŒåŒ…å«æ—¶é—´ã€æ—¥æœŸåŠå†œå†å±•ç¤º
     */
    function updateClock() {
        const now = new Date();
        const timeEl = document.getElementById('clock-time');
        const dateEl = document.getElementById('clock-date');
        const lunarEl = document.getElementById('clock-lunar');
        if(timeEl) timeEl.textContent = now.toLocaleTimeString('zh-CN', { hour12: false });
        if(dateEl) dateEl.textContent = now.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        try {
            if(lunarEl) {
                const lunar = new Intl.DateTimeFormat('zh-u-ca-chinese', {day:'numeric', month:'long'}).format(now);
                lunarEl.textContent = "å†œå† " + lunar;
            }
        } catch(e) {}
    }
    setInterval(updateClock, 1000); updateClock();

    /**
     * åŠ è½½ä¾§è¾¹æ å†å²è®°å½•æ•°æ®
     */
    function loadHistory() {
        const container = document.getElementById('history-content');
        if (container && window.siteData && window.siteData.history) {
            container.innerHTML = window.siteData.history.map(item => 
                `<div class="history-item"><span class="history-year" style="color: var(--primary-color); font-weight: bold;">${item.year}</span><br>${item.event}</div>`
            ).join('');
        }
    }

    /**
     * å±•ç¤ºé‚®ç®±å¼¹çª—ï¼Œæ”¯æŒç§»åŠ¨ç«¯è‡ªé€‚åº”å±…ä¸­æ˜¾ç¤º
     */
    function showEmail(event, email) {
        event.stopPropagation();
        const oldTip = document.getElementById('email-tooltip');
        if (oldTip) oldTip.remove();
        
        // æ‰‹æœºç«¯ä¸“ç”¨ï¼šåˆ›å»ºç‹¬ç«‹èƒŒæ™¯é®ç½©å±‚ä»¥éš”ç¦»è§†è§‰å¹²æ‰°
        let emailOverlay = null;
        if (window.innerWidth <= 768) {
            emailOverlay = document.createElement('div');
            emailOverlay.id = 'email-pop-overlay';
            emailOverlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.3);z-index:2147483646;backdrop-filter:blur(2px);';
        }
        
        const tip = document.createElement('div');
        tip.id = 'email-tooltip';
        tip.className = 'glass-card email-pop';
        tip.textContent = email;
        
        // ç§»åŠ¨ç«¯å…¨å±å±…ä¸­ï¼Œæ¡Œé¢ç«¯è·Ÿéšé¼ æ ‡ç‚¹å‡»ä½ç½®
        if (window.innerWidth <= 768) {
            tip.style.left = '50%';
            tip.style.top = '50%';
            tip.style.transform = 'translate(-50%, -50%)';
        } else {
            tip.style.left = (event.pageX + 10) + 'px';
            tip.style.top = (event.pageY + 10) + 'px';
        }
        
        // æŒ‚è½½å¼¹çª—è‡³ä¸“ç”¨å®¹å™¨æˆ– body
        const container = document.getElementById('email-pop-container') || document.body;
        if (emailOverlay) container.appendChild(emailOverlay);
        container.appendChild(tip);

        // ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¼¹çª—
        const closeTip = () => {
            tip.classList.add('fade-out');
            if (emailOverlay) {
                emailOverlay.style.opacity = '0';
                emailOverlay.style.transition = '0.3s';
            }
            setTimeout(() => {
                tip.remove();
                if (emailOverlay) emailOverlay.remove();
            }, 300);
            document.removeEventListener('click', closeTip);
        };
        setTimeout(() => document.addEventListener('click', closeTip), 10);
    }

    /**
     * åˆå§‹åŒ–å…¨ç«™æœç´¢æ¨¡å—
     */
    const sinput = document.getElementById('search-input');
    const sresults = document.getElementById('results-container');
    if(sinput) {
        sinput.addEventListener('input', () => { sresults.style.display = sinput.value ? 'block' : 'none'; });
        SimpleJekyllSearch({
            searchInput: sinput, 
            resultsContainer: sresults,
            json: '{{ site.baseurl }}/search.json',
            searchResultTemplate: '<li><a href="{url}">{title}</a></li>',
            noResultsText: '<li><p style="padding:0 15px; color:#999;">æ— å†…å®¹</p></li>',
            limit: 8
        });
    }

    /**
     * æ·±è‰²æ¨¡å¼ä¸»é¢˜åˆ‡æ¢é€»è¾‘
     */
    const themeToggle = document.getElementById('theme-toggle');
    const body = document.body;
    const icon = themeToggle ? themeToggle.querySelector('i') : null;

    const savedTheme = localStorage.getItem('theme');
    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
        body.classList.add('dark-mode');
        if(icon) icon.classList.replace('fa-sun', 'fa-moon');
    }

    if(themeToggle) {
        themeToggle.addEventListener('click', () => {
            body.classList.toggle('dark-mode');
            const isDark = body.classList.contains('dark-mode');
            if(icon) {
                if (isDark) { icon.classList.replace('fa-sun', 'fa-moon'); localStorage.setItem('theme', 'dark'); }
                else { icon.classList.replace('fa-moon', 'fa-sun'); localStorage.setItem('theme', 'light'); }
            }
        });
    }

    /**
     * åŠ¨æ¼«ç›¸å…³ç»„ä»¶åˆå§‹åŒ–
     */
    function loadAnimeExtras() {
        const cvName = document.getElementById('cv-name');
        if (cvName && window.siteData && window.siteData.cv_recommend) {
            const cv = window.siteData.cv_recommend;
            cvName.textContent = cv.name;
            document.getElementById('cv-agency').textContent = "ğŸ¢ " + cv.agency;
            document.getElementById('cv-hometown').textContent = "ğŸ“ " + cv.hometown;
            document.getElementById('cv-works').textContent = "ä»£è¡¨ä½œ: " + cv.works;
            document.getElementById('cv-intro').textContent = cv.intro;
            const wikiLink = document.getElementById('cv-wiki-link');
            if (wikiLink) { wikiLink.href = "https://zh.moegirl.org.cn/" + encodeURIComponent(cv.name); }
        }
    }

    /**
     * åˆå§‹åŒ–é¡µé¢ç»„ä»¶
     */
    window.addEventListener('DOMContentLoaded', () => {
        loadHistory();
        loadAnimeExtras();
        if (typeof loadBangumiWiki === 'function') loadBangumiWiki();

        // ç§»åŠ¨ç«¯é€‚é…é€»è¾‘ï¼šä¾§è¾¹æ åˆ‡æ¢ä¸å…ƒç´ æ¬è¿
        const menuToggle = document.getElementById('mobile-menu-toggle');
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.querySelector('.sidebar-overlay');
        const extraSidebar = document.querySelector('.extra-sidebar');
        const mobileSearchPlaceholder = document.getElementById('mobile-search-placeholder');

        if (menuToggle && sidebar && overlay) {
            // åœ¨å°å±å¹•ä¸‹å°†æœç´¢å¡ç‰‡ç§»åŠ¨è‡³ä¸»å†…å®¹åŒºé¡¶éƒ¨å ä½ç¬¦
            const handleResize = () => {
                const searchCard = document.querySelector('.search-box-card');
                if (window.innerWidth <= 768 && searchCard && mobileSearchPlaceholder) {
                    if (!mobileSearchPlaceholder.contains(searchCard)) {
                        mobileSearchPlaceholder.appendChild(searchCard);
                    }
                } else if (window.innerWidth > 768 && searchCard && extraSidebar) {
                    if (!extraSidebar.contains(searchCard)) {
                        extraSidebar.insertBefore(searchCard, extraSidebar.firstChild);
                    }
                }
            };

            window.addEventListener('resize', handleResize);
            handleResize();

            const toggleSidebar = () => {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
                document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : '';
            };

            menuToggle.addEventListener('click', toggleSidebar);
            overlay.addEventListener('click', toggleSidebar);

            // ç‚¹å‡»å¯¼èˆªé¡¹åè‡ªåŠ¨å…³é—­èœå•
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    if (sidebar.classList.contains('active')) toggleSidebar();
                });
            });
        }
    });
</script>
