<script>
    // 1. 时钟逻辑
    function updateClock() {
        const now = new Date();
        const timeEl = document.getElementById('clock-time');
        const dateEl = document.getElementById('clock-date');
        const lunarEl = document.getElementById('clock-lunar');

        if(timeEl) timeEl.textContent = now.toLocaleTimeString('zh-CN', { hour12: false });
        if(dateEl) dateEl.textContent = now.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        
        try {
            if(lunarEl) {
                const lunar = new Intl.DateTimeFormat('zh-u-ca-chinese', {day:'numeric', month:'long'}).format(now);
                lunarEl.textContent = "农历 " + lunar;
            }
        } catch(e) {}
    }
    setInterval(updateClock, 1000); updateClock();

    // 2. 历史记录加载
    function loadHistory() {
        const container = document.getElementById('history-content');
        if (container && window.siteData && window.siteData.history) {
            container.innerHTML = window.siteData.history.map(item => 
                `<div class="history-item"><span class="history-year">${item.year}</span><br>${item.event}</div>`
            ).join('');
        }
    }
    window.addEventListener('DOMContentLoaded', loadHistory);

    // 4. 动漫页面专属逻辑
    function loadAnimeExtras() {
        const cvName = document.getElementById('cv-name');
        if (cvName && window.siteData && window.siteData.cv_recommend) {
            const cv = window.siteData.cv_recommend;
            cvName.textContent = cv.name;
            document.getElementById('cv-works').textContent = "代表作: " + cv.works;
            document.getElementById('cv-feature').textContent = cv.feature;
        }

        // 识别动漫博文详情页的标签
        const wikiTitle = document.getElementById('wiki-title');
        if (wikiTitle) {
            // 获取 Jekyll 注入的标签 (这里需要一个小技巧，通过 ID 传递)
            const postTags = Array.from(document.querySelectorAll('.mini-tag')).map(t => t.textContent.trim());
            // 排除掉非动漫名的通用标签
            const ignoreTags = ['动漫', '恋爱番', '成长', '二次元', '感想', '吹水'];
            const animeTitle = postTags.find(tag => !ignoreTags.includes(tag)) || "{{ page.title }}".split(' ')[0];
            
            if (animeTitle) {
                wikiTitle.textContent = animeTitle;
                document.getElementById('wiki-desc').textContent = "点击下方按钮可直接在 Bangumi (番组计划) 中查看关于《" + animeTitle + "》的详细资料、评分及讨论。";
                document.getElementById('wiki-bgm-link').href = "https://bgm.tv/subject_search/" + encodeURIComponent(animeTitle) + "?cat=2";
            }
        }
    }
    window.addEventListener('DOMContentLoaded', loadAnimeExtras);
    const sinput = document.getElementById('search-input');
    const sresults = document.getElementById('results-container');
    if(sinput) {
        sinput.addEventListener('input', () => { sresults.style.display = sinput.value ? 'block' : 'none'; });
        SimpleJekyllSearch({
            searchInput: sinput, 
            resultsContainer: sresults,
            json: '{{ site.baseurl }}/search.json',
            searchResultTemplate: '<li><a href="{url}">{title}</a></li>',
            noResultsText: '<li><p style="padding:0 15px; color:#999;">无内容</p></li>',
            limit: 8
        });
    }
</script>
